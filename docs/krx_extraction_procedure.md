# KRX 외국인 주식보유 데이터 추출 절차

이 문서는 프로젝트에서 사용된 KRX(한국거래소) 전체 시장의 외국인 보유 비중 데이터를 추출하는 절차와 로직을 설명합니다.

## 1. 개요

- **목표 데이터**: KRX 정보데이터시스템의 [[12022] 외국인보유량 추이](http://data.krx.co.kr/contents/MDC/MDI/mdiLoader/index.cmd?menuId=MDC0201020503) "전체" 시장 데이터 중 최신 일자의 시가총액 기준 외국인 보유량 및 비중.
- **사용 라이브러리**: `pykrx`
- **구현 파일**: `backend/crawler/krx_crawler.py`

## 2. 데이터 정합성 이슈 및 해결

### 문제점

- **장중 데이터 불일치**: KRX 웹사이트의 해당 통계 화면은 **장 마감 후 확정된 종가 데이터**를 기준으로 일별 추이를 보여줍니다. 반면 API로 실시간 데이터를 조회하면 장중 변동성이 반영되어 웹사이트의 표시 값(전일 종가 기준)과 차이가 발생했습니다.
- **집계 기준 차이**: 단순히 KOSPI와 KOSDAQ만 합산할 경우, KRX 웹사이트의 "전체" 기준(KOSPI + KOSDAQ + KONEX 전체 종목)과 미세한 오차가 발생했습니다.

### 해결 전략

1. **데이터 기준 시점 동기화**:
   - 현재 시간이 **16:00 (장 마감)** 이전인 경우, 아직 종가가 확정되지 않았다고 판단하여 **전일 데이터**를 기준으로 추출합니다.
   - 이를 통해 사용자가 장 중에 조회하더라도 웹사이트 표(전일 종가 기준)와 일치하는 데이터를 제공합니다.
2. **전체 시장 합산**:
   - `pykrx`의 시장 파라미터를 `ALL`로 설정하여 KOSPI, KOSDAQ, KONEX를 모두 포함한 전 종목 데이터를 수집합니다.
   - 종목별 `(외국인보유수량 * 종가)`를 계산한 후 전체 합산하여 정확도를 높였습니다.

## 3. 상세 추출 로직 (알고리즘)

1. **기준 날짜 설정**:

   - `datetime.now()`를 호출합니다.
   - `시간 < 16시` 이면: `검색 시작일 = 어제`
   - `시간 >= 16시` 이면: `검색 시작일 = 오늘`

2. **데이터 탐색 (최근 7일 역순)**:

   - 휴일이나 데이터가 없는 날을 대비하여 검색 시작일로부터 과거 7일간 역순으로 데이터를 조회합니다.
   - `market="ALL"` 옵션으로 데이터 존재 여부를 확인합니다.

3. **데이터 수집 및 계산**:

   - **`stock.get_market_cap(날짜, market="ALL")`**: 전 종목의 종가 및 시가총액 정보를 가져옵니다.
   - **`stock.get_exhaustion_rates_of_foreign_investment_by_ticker(날짜, market="ALL")`**: 전 종목의 외국인 보유수량을 가져옵니다.
   - 두 데이터프레임을 **Ticker(종목코드)** 기준으로 교집합(Intersection) 병합합니다.

4. **최종 지표 산출**:
   - **외국인 보유 시가총액** = $\sum (\text{개별종목 외국인 보유주식수} \times \text{개별종목 종가})$
   - **전체 시가총액** = $\sum (\text{개별종목 시가총액})$
   - **외국인 보유 비중(%)** = $(\text{외국인 보유 시가총액} / \text{전체 시가총액}) \times 100$

## 4. 결과 검증

- 2025년 12월 15일(월) 기준 검증 결과:
  - 시스템 추출 값 (기준일 2025-12-12): **31.82%** (1,255조 / 3,945조)
  - KRX 웹사이트 표시 값 (기준일 2025/12/12): **31.82%**
  - **결과 일치 확인**
