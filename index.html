<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Finance Dashboard</title>
    <style>
        :root {
            --bg-dark: #0f172a;
            --bg-card: #141b2d;
            --border-color: rgba(255, 255, 255, 0.08);
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --accent-gold: #fbbf24;
            --shadow-card: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            background: radial-gradient(circle at top right, #1e293b, #0f172a 60%, #020617);
            color: var(--text-primary);
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            font-size: 16px;
        }

        /* Header */
        header {
            width: 100%;
            padding: 1.5rem 0 1rem;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 1.2rem;
            z-index: 100;
            flex-shrink: 0;
        }

        .header-title {
            font-size: 1.1rem;
            color: #60a5fa;
            font-weight: 600;
            opacity: 0.9;
        }

        .nav-container {
            display: flex;
            gap: 0.8rem;
            background: rgba(255, 255, 255, 0.05);
            padding: 0.4rem;
            border-radius: 9999px;
            border: 1px solid var(--border-color);
        }

        .nav-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 0.5rem 1.4rem;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .nav-btn:hover {
            color: var(--text-primary);
        }

        .nav-btn.active {
            background: var(--text-primary);
            color: var(--bg-dark);
            font-weight: 700;
        }

        /* Main */
        main {
            flex: 1;
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 0 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            min-height: 0;
        }

        /* Titles */
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-top: 1rem;
            margin-bottom: 0.6rem;
        }

        .section-bar {
            width: 4px;
            height: 1.2rem;
            background-color: var(--accent-gold);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Grids */
        .dashboard-grid {
            display: grid;
            gap: 1.5rem;
        }

        .split-grid {
            grid-template-columns: 1fr 1fr;
        }

        .grid-7-3 {
            grid-template-columns: 2.3fr 1fr;
        }

        /* 70:30 Ratio */
        .four-grid {
            grid-template-columns: repeat(4, 1fr);
        }

        /* Card */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1.2rem;
            padding: 1rem 1.2rem;
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .card-header-title {
            font-size: 1rem;
            font-weight: 700;
            color: #fff;
            margin-bottom: 0.5rem;
        }

        /* Indices 3-Col Row (Shared) */
        .indices-row-3col {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 0.3rem;
            margin-bottom: 0.3rem;
            cursor: pointer;
        }

        .indices-row-3col:last-child {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 0;
        }

        .idx-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #94a3b8;
            text-align: left;
        }

        .idx-price-center {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            text-align: center;
        }

        .idx-right-group {
            text-align: right;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            align-items: flex-end;
        }

        .idx-change-val {
            font-size: 1rem;
            font-weight: 600;
        }

        .idx-change-pct {
            font-size: 0.85rem;
            font-weight: 500;
            opacity: 0.9;
        }

        /* 2-Column Indices Grid (Internal) */
        .indices-2col-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            /* Space between columns */
        }

        .indices-col {
            display: flex;
            flex-direction: column;
        }

        /* Sentiment */
        .sentiment-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .sentiment-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .sentiment-label {
            font-size: 1.1rem;
            color: #94a3b8;
            font-weight: 500;
        }

        .sentiment-val {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            text-align: right;
        }

        .sentiment-change {
            font-size: 0.9rem;
            font-weight: 500;
            text-align: right;
        }

        /* Val with Dates / Simple */
        .sv-top-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }

        .sv-label {
            font-size: 1rem;
            color: #94a3b8;
            font-weight: 600;
        }

        .sv-badge {
            font-size: 0.85rem;
            font-weight: 600;
            padding: 0.2rem 0.6rem;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.08);
            color: #fff;
        }

        .sv-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: #fff;
            line-height: 1.1;
        }

        .sv-footer {
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
            font-size: 0.8rem;
            color: #64748b;
        }

        /* Large Center */
        .large-center-box {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        /* Standard List */
        .std-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.6rem;
            cursor: pointer;
        }

        .std-row:last-child {
            margin-bottom: 0;
        }

        .std-label {
            font-size: 1rem;
            color: #94a3b8;
        }

        .std-val {
            font-size: 1.2rem;
            font-weight: 700;
            color: #fff;
            text-align: right;
        }

        .std-change {
            font-size: 0.85rem;
            text-align: right;
        }

        /* Charts */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1.5rem;
            height: 100%;
        }

        .chart-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 1.2rem;
            padding: 1.2rem 1.5rem;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 250px;
        }

        .chart-title {
            font-size: 1rem;
            color: #fff;
            margin-bottom: 0.8rem;
            font-weight: 700;
            text-align: center;
        }

        /* Specific Layout Tweaks */
        /* Stocks Tab (7:3) - Taller Cards */
        .grid-7-3 .card {
            min-height: 320px;
            padding: 1.5rem 1.8rem;
            justify-content: flex-start;
            /* Pin header to top */
            gap: 1.5rem;
            /* Gap between header and content */
        }

        /* Distribute items inside Stocks cards */
        .grid-7-3 .card .indices-2col-container {
            flex: 1;
            /* Grid container itself just holds columns. Columns need to stretch. */
        }

        .grid-7-3 .card .indices-col {
            display: flex;
            flex-direction: column;
            justify-content: center;
            /* Center items vertically for equal margins */
            gap: 26px;
            /* Exact pixel spacing as requested */
            height: 100%;
        }

        .grid-7-3 .card .sentiment-list {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-evenly;
            /* Distribute list items */
        }

        /* Rates/Exchange Tab (Four Grid) - Compact Cards */
        .four-grid .card {
            min-height: 0;
            padding: 0.8rem 1rem;
        }

        /* Utilities */
        .c-up {
            color: #f87171;
        }

        .c-down {
            color: #60a5fa;
        }

        .bg-up {
            background: rgba(248, 113, 113, 0.15);
            color: #f87171;
        }

        .bg-down {
            background: rgba(96, 165, 250, 0.15);
            color: #60a5fa;
        }

        @media (max-width: 1024px) {

            .split-grid,
            .four-grid,
            .grid-7-3 {
                grid-template-columns: 1fr;
            }

            .indices-2col-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <header>
        <div class="header-title" id="current-date">Thinking...</div>
        <nav class="nav-container">
            <button class="nav-btn active" onclick="switchCategory('stocks')">미국 증시</button>
            <button class="nav-btn" onclick="switchCategory('economy')">실물경제</button>
            <button class="nav-btn" onclick="switchCategory('rates')">금리</button>
            <button class="nav-btn" onclick="switchCategory('exchange')">환율</button>
        </nav>
        <div id="refresh-timer" style="
			position: absolute;
			right: 20px;
			top: 20px;
			font-size: 0.9rem;
			color: #94a3b8;
		">
            다음 갱신까지: --초
        </div>

    </header>

    <main id="main-content">
        <!-- Content -->
    </main>

    <script>

        let nextUpdateTimeMs = null;
        let timerTriggered = false;

        async function fetchTimer() {
            try {
                const res = await fetch(`${API_BASE_URL.replace('/api/finance', '')}/api/timer`);
                const data = await res.json();

                if (!data.next_update) return;

                const now = Date.now();
                // Backend job might take a moment. If next_update is in past/present, retry.
                if (data.next_update > now + 2000) {
                    nextUpdateTimeMs = data.next_update;
                    timerTriggered = false; // Valid future time received, reset trigger
                } else {
                    console.log("Waiting for new schedule...", data.next_update, now);
                    // Still old schedule? Retry fetch soon
                    setTimeout(fetchTimer, 2000);
                }
            } catch (e) {
                console.error("Timer fetch failed", e);
                setTimeout(fetchTimer, 5000);
            }
        }

        const CATEGORIES = {
            stocks: {
                layoutClass: 'grid-7-3', // Changed to 7:3
                groups: [
                    {
                        id: 'us_market',
                        label: '미국 주요 지수', // Renamed
                        type: 'indices_2x3_grid', // New type for 2 columns x 3 rows
                        items: [
                            // Left Col
                            { id: 'sp_futures', label: 'S&P 500', url: 'https://kr.investing.com/indices/us-spx-500-futures' },
                            { id: 'dow_futures', label: 'DOW', url: 'https://kr.investing.com/indices/us-30-futures' },
                            { id: 'nasdaq_futures', label: 'NASDAQ', url: 'https://kr.investing.com/indices/nq-100-futures' },
                            // Right Col
                            { id: 'wti', label: 'WTI 유가/원자재', url: 'https://kr.investing.com/commodities/crude-oil' },
                            { id: 'russell', label: '러셀 2000', url: 'https://kr.investing.com/indices/us-small-cap-2000' },
                            { id: 'high_yield', label: '하이일드 스프레드', url: 'https://www.indexergo.com/series/?frq=M&idxDetail=13404' }
                        ]
                    },
                    {
                        id: 'sentiment',
                        label: '투자 심리',
                        type: 'sentiment_list',
                        items: [
                            { id: 'vix', label: 'VIX', url: 'https://kr.investing.com/indices/volatility-s-p-500' },
                            { id: 'fear_greed', label: '공포탐욕 지수', url: 'https://edition.cnn.com/markets/fear-and-greed' }
                        ]
                    }
                ],
                charts: [
                    { id: 'sp_chart', label: 'S&P 500' },
                    { id: 'dow_chart', label: 'DOW' },
                    { id: 'nasdaq_chart', label: 'NASDAQ' }
                ]
            },
            economy: {
                layoutClass: 'four-grid',
                groups: [
                    { id: 'cci_card', label: '소비자신뢰지수', type: 'val_with_dates', items: [{ id: 'cci', url: 'https://kr.investing.com/economic-calendar/cb-consumer-confidence-48' }] },
                    { id: 'pmi_card', label: '제조업 PMI', type: 'val_with_dates', items: [{ id: 'pmi', url: 'https://kr.investing.com/economic-calendar/ism-manufacturing-pmi-173' }] },
                    { id: 'unem_card', label: '실업률', type: 'val_with_dates', items: [{ id: 'unemployment', url: 'https://kr.investing.com/economic-calendar/unemployment-rate-300' }] },
                    { id: 'nfp_card', label: '비농업고용', type: 'val_with_dates', items: [{ id: 'non_farm', url: 'https://kr.investing.com/economic-calendar/nonfarm-payrolls-227' }] }
                ],
                charts: [
                    { id: 'cci_chart', label: '소비자신뢰지수' },
                    { id: 'unem_chart', label: '실업률' }
                ]
            },
            rates: {
                layoutClass: 'four-grid',
                groups: [
                    {
                        id: 'us_rates', label: '미국 (USA)', type: 'std_list',
                        items: [
                            { id: 'us_10y', label: '10년물', url: 'https://kr.investing.com/rates-bonds/u.s.-10-year-bond-yield' },
                            { id: 'us_2y', label: '2년물', url: 'https://kr.investing.com/rates-bonds/u.s.-2-year-bond-yield' },
                            { id: 'us_10_2_spread', label: '10-2년차', url: 'https://fred.stlouisfed.org/series/T10Y2Y' },
                            { id: 'fed_rate', label: '기준금리', url: 'https://kr.investing.com/economic-calendar/interest-rate-decision-168' }
                        ]
                    },
                    {
                        id: 'jp_rates', label: '일본 (JPN)', type: 'std_list',
                        items: [
                            { id: 'jp_2y', label: '2년물', url: 'https://kr.investing.com/rates-bonds/japan-2-year-bond-yield' },
                            { id: 'jp_policy', label: '정책금리', url: 'https://kr.investing.com/economic-calendar/boj-interest-rate-decision-164' }
                        ]
                    },
                    {
                        id: 'kr_rates', label: '한국 (KOR)', type: 'std_list',
                        items: [
                            { id: 'kr_10y', label: '10년물', url: 'https://kr.investing.com/rates-bonds/south-korea-10-year-bond-yield' },
                            { id: 'kr_2y', label: '2년물', url: 'https://kr.investing.com/rates-bonds/south-korea-2-year-bond-yield' },
                            { id: 'kr_base', label: '기준금리', url: 'https://kr.investing.com/economic-calendar/south-korea-interest-rate-decision-473' }

                        ]
                    },
                    {
                        id: 'sofr_card', label: '', type: 'large_center',
                        items: [{ id: 'sofr', label: 'SOFR', url: 'https://www.newyorkfed.org/markets/reference-rates/sofr' }]
                    }
                ],
                charts: [
                    { id: 'us10_chart', label: '미국 10년물' },
                    { id: 'us2_chart', label: '미국 2년물' },
                    { id: 'spread_chart', label: '10-2년차 Spread' }
                ]
            },
            exchange: {
                layoutClass: 'four-grid',
                groups: [
                    { id: 'dxy_card', label: '달러인덱스', type: 'val_simple', items: [{ id: 'dxy', url: 'https://kr.investing.com/currencies/us-dollar-index' }] },
                    { id: 'krw_card', label: '원/달러 환율', type: 'val_simple', items: [{ id: 'usd_krw', url: 'https://finance.yahoo.com/quote/KRW%3DX/' }] },
                    { id: 'res_card', label: '외환보유고', type: 'val_with_dates', items: [{ id: 'foreign_reserves', url: 'https://kr.investing.com/economic-calendar/south-korea-fx-reserves-usd-1889' }] },
                    { id: 'bond_card', label: '외국인 주식보유', type: 'val_with_dates', items: [{ id: 'foreign_bond', url: 'https://www.index.go.kr/unity/potal/main/EachDtlPageDetail.do?idx_cd=1086' }] },

                ],
                charts: [
                    { id: 'dxy_chart', label: '달러인덱스' },
                    { id: 'krw_chart', label: '원/달러 환율' }
                ]
            }
        };

        // Initial Empty State - Populated by Backend API
        let MOCK_DATA = {
            stocks: {},
            economy: {},
            rates: {},
            exchange: {}
        };

        const API_BASE_URL = 'https://usa-invest.onrender.com/api/finance';
        //const API_BASE_URL = "http://127.0.0.1:8000/api/finance";


        let currentCategory = 'stocks';
        let chartInstances = {};

        window.onload = async () => {
            // Update Russell URL
            const russellItem = CATEGORIES.stocks.groups[0].items.find(i => i.id === 'russell');
            if (russellItem) {
                russellItem.url = 'https://www.google.com/finance/quote/RUT:INDEXRUSSELL?hl=ko';
            }

            updateDate();

            // Initial render (empty)
            renderLayout(currentCategory);

            // Fetch Data
            await fetchAllData();

            // Timer Sync with Backend
            await fetchTimer();

            // Start Countdown
            startCountdown();
        };


        function updateDate() {
            const now = new Date();
            const dateStr = now.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
            document.getElementById('current-date').innerText = dateStr;
        }

        function switchCategory(cat) {
            if (currentCategory === cat) return;
            currentCategory = cat;
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            const btns = document.querySelectorAll('.nav-btn');
            for (let b of btns) {
                if (b.getAttribute('onclick').includes(cat)) b.classList.add('active');
            }
            renderLayout(cat);
        }

        let timerRunning = false;

        function startCountdown() {
            if (timerRunning) return;
            timerRunning = true;

            setInterval(() => {
                if (!nextUpdateTimeMs) return;

                const now = Date.now();
                const diffSec = Math.max(
                    Math.floor((nextUpdateTimeMs - now) / 1000),
                    0
                );

                const timerEl = document.getElementById("refresh-timer");
                timerEl.textContent = `다음 갱신까지: ${diffSec}초`;

                // ✅ 0초 도달 시 단 한 번만 실행
                if (diffSec === 0 && !timerTriggered) {
                    timerTriggered = true;

                    fetchAllData(); // 이미 갱신된 캐시 읽기
                    fetchTimer();   // 다음 next_update 재동기화
                }
            }, 1000);
        }



        async function fetchAllData() {
            try {
                // Parallel Fetch
                const [stocks, economy, rates, exchange, _history] = await Promise.all([
                    fetch(`${API_BASE_URL}/stocks`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/economy`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/rates`).then(r => r.json()),
                    fetch(`${API_BASE_URL}/exchange`).then(r => r.json()),
                    fetchHistoryData()
                ]);

                if (stocks) MOCK_DATA.stocks = stocks;
                if (economy) MOCK_DATA.economy = economy;
                if (rates) MOCK_DATA.rates = rates;
                if (exchange) MOCK_DATA.exchange = exchange;

                // Re-render current category with data
                renderLayout(currentCategory);
                console.log('Backend Data Loaded:', MOCK_DATA);

            } catch (e) {
                console.error("Backend connection failed:", e);
                // Optional: alert('Data sync failed. Check server.');
            }
        }

        function renderLayout(category) {
            const main = document.getElementById('main-content');
            main.innerHTML = '';
            Object.values(chartInstances).forEach(c => c.destroy());
            chartInstances = {};

            const config = CATEGORIES[category];

            // Header
            const cardHeader = document.createElement('div');
            cardHeader.className = 'section-header';
            cardHeader.innerHTML = `<div class="section-bar"></div><div class="section-title">주요 지표</div>`;
            main.appendChild(cardHeader);

            // Cards
            const cardsSection = document.createElement('div');
            const grid = document.createElement('div');
            grid.className = `dashboard-grid ${config.layoutClass || ''}`;
            config.groups.forEach(group => grid.appendChild(createCard(group)));
            cardsSection.appendChild(grid);
            main.appendChild(cardsSection);

            // Charts
            if (config.charts) {
                const chartHeader = document.createElement('div');
                chartHeader.className = 'section-header';
                chartHeader.innerHTML = `<div class="section-bar"></div><div class="section-title">상세 그래프</div>`;
                main.appendChild(chartHeader);

                const cGrid = document.createElement('div');
                cGrid.className = 'charts-grid';
                config.charts.forEach(c => cGrid.appendChild(createChartCard(c)));
                main.appendChild(cGrid);
            }

            // Populate Data
            updateUI(category, MOCK_DATA[category]);
        }

        function createIndicesRow(item) {
            const row = document.createElement('div');
            row.className = 'indices-row-3col';
            // Flex layout: Label(Left) - Value(Center) - Change&Pct(Right)
            row.style.display = 'flex';
            row.id = `card-item-${item.id}`;

            if (item.url) row.onclick = () => window.open(item.url, '_blank');


            row.innerHTML = `
                <div class="idx-name" style="flex:1; text-align:left;">${item.label}</div>
                <div class="idx-val center-align" id="val-${item.id}" style="flex:1; text-align:center; font-size:1.1rem; font-weight:700; color:#fff;">...</div>
                <div class="idx-right-group" style="flex:1; text-align:right;">
                     <!-- Combined Change and Percent -->
                     <div class="idx-change loading-pulse" id="ch-${item.id}">--</div>
                     <div id="date-row-${item.id}" style="display:none; font-size: 0.75rem; color: #6c757d; margin-top: 2px; text-align: right;">
                    <span id="next-${item.id}">--</span>
                </div>
                </div>
            `;
            return row;
        }

        function createCard(group) {
            const div = document.createElement('div');
            div.className = 'card';

            if (group.type === 'indices_2x3_grid') {
                div.innerHTML = `<div class="card-header-title">${group.label}</div>`;
                const container = document.createElement('div');
                container.className = 'indices-2col-container';

                // Split into 2 arrays: first 3, and rest
                const leftItems = group.items.slice(0, 3);
                const rightItems = group.items.slice(3, 6);

                const leftCol = document.createElement('div');
                leftCol.className = 'indices-col';
                leftItems.forEach(item => {
                    leftCol.appendChild(createIndicesRow(item));
                });

                const rightCol = document.createElement('div');
                rightCol.className = 'indices-col';
                rightItems.forEach(item => {
                    rightCol.appendChild(createIndicesRow(item));
                });

                container.appendChild(leftCol);
                container.appendChild(rightCol);
                div.appendChild(container);

            } else if (group.type === 'indices_3col') {
                div.innerHTML = `<div class="card-header-title">${group.label}</div>`;
                const list = document.createElement('div');
                list.className = 'indices-list';
                group.items.forEach(item => {
                    list.appendChild(createIndicesRow(item));
                });
                div.appendChild(list);

            } else if (group.type === 'std_list') {
                div.innerHTML = `<div class="card-header-title">${group.label}</div>`;
                const list = document.createElement('div');
                list.className = 'std-list';
                group.items.forEach(item => {
                    const container = document.createElement('div');
                    container.id = `card-item-${item.id}`;
                    container.style.borderBottom = '1px solid rgba(255,255,255,0.05)';
                    container.style.paddingBottom = '0.6rem';
                    container.style.marginBottom = '0.6rem';
                    if (item.url) { container.style.cursor = 'pointer'; container.onclick = () => window.open(item.url, '_blank'); }


                    container.innerHTML = `
                        <div class="std-row" style="display:flex; justify-content:space-between; align-items:center;">
                            <span class="std-label" style="color:#94a3b8;">${item.label}</span>
                            <div style="text-align:right;">
                                <div class="std-val loading-pulse" id="val-${item.id}" style="font-size:1.1rem; font-weight:700; color:#fff;">...</div>
                                <div class="std-change loading-pulse" id="ch-${item.id}" style="font-size:0.85rem;">--</div>
                            </div>
                        </div>
                        <div id="date-row-${item.id}" style="display:none; text-align:right; font-size:0.75rem; color:#64748b; margin-top:2px;">
                            <span id="date-${item.id}"></span> | 다음: <span id="next-${item.id}"></span>
                        </div>
                    `;
                    list.appendChild(container);
                });
                div.appendChild(list);

            } else if (group.type === 'sentiment_list') {
                div.innerHTML = `<div class="card-header-title">${group.label}</div>`;
                const list = document.createElement('div');
                list.className = 'sentiment-list';
                group.items.forEach(item => {
                    const row = document.createElement('div');
                    row.className = 'sentiment-row';
                    row.id = `card-item-${item.id}`;
                    if (item.url) row.onclick = () => window.open(item.url, '_blank');

                    row.innerHTML = `
                        <div class="sentiment-label">${item.label}</div>
                        <div class="sentiment-val-group">
                             <div class="sentiment-val loading-pulse" id="val-${item.id}">...</div>
                             <div class="sentiment-change loading-pulse" id="ch-${item.id}">--</div>
                        </div>
                     `;
                    list.appendChild(row);
                });
                div.appendChild(list);

            } else if (group.type === 'val_with_dates') {
                const item = group.items[0];
                div.id = `card-item-${item.id}`;
                if (item.url) { div.style.cursor = 'pointer'; div.onclick = () => window.open(item.url, '_blank'); }

                div.innerHTML = `
                    <div class="sv-top-row">
                        <span class="sv-label">${group.label}</span>
                        <span class="sv-badge loading-pulse" id="ch-${item.id}">--</span>
                    </div>
                    <div class="sv-value loading-pulse" id="val-${item.id}">...</div>
                    <div class="sv-footer">
                        <span>발표: <span id="date-${item.id}">--</span></span>
                        <span>다음: <span id="next-${item.id}">--</span></span>
                    </div>
                 `;

            } else if (group.type === 'val_simple') {
                const item = group.items[0];
                div.id = `card-item-${item.id}`;
                if (item.url) { div.style.cursor = 'pointer'; div.onclick = () => window.open(item.url, '_blank'); }

                div.innerHTML = `
                    <div class="sv-top-row">
                        <span class="sv-label">${group.label}</span>
                        <span class="sv-badge loading-pulse" id="ch-${item.id}">--</span>
                    </div>
                    <div class="sv-value loading-pulse" id="val-${item.id}">...</div>
                 `;
            } else if (group.type === 'large_center') {
                const item = group.items[0];
                div.id = `card-item-${item.id}`;
                if (item.url) { div.style.cursor = 'pointer'; div.onclick = () => window.open(item.url, '_blank'); }

                div.innerHTML = `
                    <div class="large-center-box">
                        <span style="font-size:1.2rem; color:#94a3b8; margin-bottom:0.8rem">${item.label}</span>
                        <div class="large-val loading-pulse" id="val-${item.id}" style="font-size:3rem; font-weight:800; color:#fff; line-height:1;">...</div>
                        <div class="large-change loading-pulse" id="ch-${item.id}" style="font-size:1.1rem; margin-top:0.4rem;">--</div>
                    </div>
                `;
            }
            return div;
        }

        function createChartCard(c) {
            const div = document.createElement('div');
            div.className = 'chart-card';
            div.innerHTML = `
                <div class="chart-title">${c.label} Trend</div>
                <div style="flex:1; position:relative; width:100%; height:100%">
                    <canvas id="${c.id}"></canvas>
                </div>
            `;
            return div;
        }

        async function fetchData(category) {
            updateUI(category, MOCK_DATA[category]);
        }

        function updateUI(category, data) {
            const config = CATEGORIES[category];

            // 1. Update Cards
            config.groups.forEach(g => {
                g.items.forEach(item => {
                    const d = data[item.id];
                    if (!d) return;

                    // Update Dynamic URL if provided by backend (fallback triggered)
                    if (d.url) {
                        const clickable = document.getElementById(`card-item-${item.id}`);
                        if (clickable) {
                            clickable.onclick = () => window.open(d.url, '_blank');
                        }
                    }

                    const valEl = document.getElementById(`val-${item.id}`);
                    const chEl = document.getElementById(`ch-${item.id}`);
                    const dateEl = document.getElementById(`date-${item.id}`);
                    const nextEl = document.getElementById(`next-${item.id}`);
                    const dateRowEl = document.getElementById(`date-row-${item.id}`);

                    if (valEl) {
                        let txt = d.value;
                        if ((item.id === 'fear_greed' || item.id === 'sofr') && !String(txt).includes('%')) txt += '%';
                        valEl.innerText = txt;
                        valEl.classList.remove('loading-pulse');
                    }

                    if (chEl) {
                        // High Yield special: Date row visibility check
                        if ((item.id === 'high_yield' || g.type === 'indices_3col' || g.type === 'indices_2x3_grid') && d.next) {
                            if (dateRowEl) {
                                dateRowEl.style.display = 'block';
                                const pDate = document.getElementById(`date-${item.id}`);
                                const pNext = document.getElementById(`next-${item.id}`);

                                if (pDate) pDate.innerText = d.date || '';
                                if (pNext) pNext.innerText = d.next || d.next_date || '';
                            }
                        }

                        // Hide change for Policy Rates
                        if (item.id === 'fear_greed' || item.id === 'fed_rate' || item.id === 'jp_policy' || item.id === 'kr_base') {
                            chEl.style.display = 'none';
                        } else if (item.id === 'non_farm') {
                            chEl.innerText = '-';
                            chEl.className = 'sv-badge';
                        } else {
                            let raw = d.change || "0";
                            let rawPct = d.percent;
                            if (canFormat(raw)) raw = formatNumber(raw);

                            const dir = getDirection(d.change);

                            // Indices Grid: Single Line Format
                            if (g.type === 'indices_3col' || g.type === 'indices_2x3_grid') {
                                // Format: -1.75 (-0.03%)
                                let disp = raw;
                                if (rawPct) disp += ` (${formatNumber(rawPct)}%)`;

                                chEl.innerText = disp;
                                chEl.className = 'indices-change-val';
                                if (dir === 'up') chEl.classList.add('c-up');
                                else if (dir === 'down') chEl.classList.add('c-down');

                            } else {
                                // Standard / SV
                                let disp = raw;
                                if (rawPct) disp += ` (${formatNumber(rawPct)}%)`;
                                chEl.innerText = disp;

                                chEl.className = '';
                                if (g.type === 'val_with_dates' || g.type === 'val_simple') {
                                    chEl.className = 'sv-badge';
                                    if (dir === 'up') chEl.classList.add('bg-up');
                                    else if (dir === 'down') chEl.classList.add('bg-down');
                                } else {
                                    chEl.style.fontWeight = '500';
                                    if (dir === 'up') chEl.classList.add('c-up');
                                    else if (dir === 'down') chEl.classList.add('c-down');
                                }
                            }
                            chEl.classList.remove('loading-pulse');
                        }
                    }



                    // General Date Handling
                    if (d.date || d.next || d.next_date) {
                        if (dateRowEl) dateRowEl.style.display = 'block';
                        if (dateEl) dateEl.innerText = d.date || '';
                        if (nextEl) {
                            if (d.next_date && d.next_date.trim() !== '') {
                                nextEl.innerText = d.next_date;
                            } else if (d.next && d.next.trim() !== '') { // Keep d.next if d.next_date is empty
                                nextEl.innerText = d.next;
                            } else {
                                nextEl.innerText = '미발표';
                                nextEl.style.color = '#64748b'; // Dim color for n/a
                            }
                        }
                    }

                    // Special Logic for e-Nara Foreign Holding (foreign_bond)
                    if (item.id === 'foreign_bond') {
                        if (valEl) {
                            valEl.style.fontSize = '1.0rem'; // Adjust for Amount+Unit
                        }
                        if (chEl) {
                            chEl.innerText = d.percent;
                            chEl.style.backgroundColor = 'rgba(255, 255, 255, 0.1)';
                            chEl.style.color = '#fff';
                            chEl.classList.remove('bg-up', 'bg-down', 'c-up', 'c-down', 'loading-pulse');
                        }
                        // Hide 'Next' date as e-Nara is manual/monthly
                        if (nextEl && nextEl.parentElement) {
                            nextEl.parentElement.style.display = 'none';
                        }
                    }

                });
            });

            // 2. Update Charts
            if (config.charts) {
                config.charts.forEach(c => {
                    const ctx = document.getElementById(c.id);

                    // Determine current value for the chart
                    let dataId = null;
                    if (c.id === 'sp_chart') dataId = 'sp_futures';
                    else if (c.id === 'dow_chart') dataId = 'dow_futures';
                    else if (c.id === 'nasdaq_chart') dataId = 'nasdaq_futures';
                    else if (c.id === 'cci_chart') dataId = 'cci';
                    else if (c.id === 'unem_chart') dataId = 'unemployment';
                    else if (c.id === 'us10_chart') dataId = 'us_10y';
                    else if (c.id === 'us2_chart') dataId = 'us_2y';
                    else if (c.id === 'spread_chart') dataId = 'us_10_2_spread';
                    else if (c.id === 'dxy_chart') dataId = 'dxy';
                    else if (c.id === 'krw_chart') dataId = 'usd_krw';

                    let currentVal = 100;
                    // Attempt to find data in current category
                    if (dataId && MOCK_DATA[category] && MOCK_DATA[category][dataId]) {
                        let raw = MOCK_DATA[category][dataId].value;
                        let cleanVal = raw.replace(/,/g, '').replace(/%/g, '').replace(/K/g, '').replace(/억\$/g, '').replace(/조원/g, '');
                        let parsed = parseFloat(cleanVal);
                        if (!isNaN(parsed)) currentVal = parsed;
                    } else if (dataId) {
                        // Search other categories
                        for (let cat in MOCK_DATA) {
                            if (MOCK_DATA[cat][dataId]) {
                                let raw = MOCK_DATA[cat][dataId].value;
                                let cleanVal = raw.replace(/,/g, '').replace(/%/g, '').replace(/K/g, '').replace(/억\$/g, '').replace(/조원/g, '');
                                let parsed = parseFloat(cleanVal);
                                if (!isNaN(parsed)) currentVal = parsed;
                                break;
                            }
                        }
                    }

                    if (ctx && !chartInstances[c.id]) initChart(ctx, c.id, currentVal);
                });
            }
        }



        // --- History Data ---
        let HISTORY_DATA = {};

        async function fetchHistoryData() {
            try {
                const res = await fetch(`${API_BASE_URL}/history`);
                if (res.ok) {
                    HISTORY_DATA = await res.json();
                    console.log("[Front] History fetched:", Object.keys(HISTORY_DATA));
                }
            } catch (e) {
                console.error("[Front] History fetch failed:", e);
            }
        }


        // ... (Charts)

        function initChart(ctx, id, currentVal) {
            // Default Empty
            let values = [];
            let labels = [];

            // 1. Get History
            if (HISTORY_DATA[id]) {
                const h = HISTORY_DATA[id];
                if (h.values && h.dates) {
                    values = [...h.values]; // Copy
                    labels = [...h.dates];
                }
            }

            // 2. Append Current Value (Realtime connection)
            // Only if currentVal is valid
            if (currentVal !== null && !isNaN(currentVal)) {
                // Check last date to avoid dups? 
                // Simple logic: Just append "Now" or Today
                values.push(currentVal);
                labels.push("Current");
            }

            // Fallback if no data
            if (values.length === 0) {
                values = [currentVal || 100, currentVal || 100];
                labels = ["Start", "End"];
            }

            // Determine Color
            const startVal = values[0];
            const endVal = values[values.length - 1];
            const isUp = endVal >= startVal;
            const color = isUp ? '#f87171' : '#60a5fa'; // Red : Blue

            // Simplify Labels (Show only start/end or every Nth?)
            // Chart.js handles this automatically usually, but let's hide x-grid


            // Format Labels: Convert YYYY-MM-DD to YY.MM (e.g., 24.12)
            const formattedLabels = labels.map(l => {
                if (l === "Current" || l === "Now") return "Now";
                // l is "YYYY-MM-DD"
                if (l.length >= 7) {
                    return `${l.substring(2, 4)}.${l.substring(5, 7)}`;
                }
                return l;
            });


            chartInstances[id] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: formattedLabels,
                    datasets: [{
                        data: values,
                        borderColor: color,
                        borderWidth: 2,
                        pointRadius: 2, // Show small points for month
                        pointHoverRadius: 4,
                        fill: true,
                        backgroundColor: (ctx) => {
                            const grad = ctx.chart.ctx.createLinearGradient(0, 0, 0, ctx.chart.height);
                            grad.addColorStop(0, isUp ? 'rgba(248, 113, 113, 0.25)' : 'rgba(96, 165, 250, 0.25)');
                            grad.addColorStop(1, 'rgba(0,0,0,0)');
                            return grad;
                        },
                        tension: 0.4 // Smoother curve for monthly
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                    scales: {
                        x: {
                            display: true, // Show X Axis
                            grid: { display: false },
                            ticks: {
                                color: '#94a3b8',
                                font: { size: 10 },
                                maxRotation: 0,
                                autoSkip: false, // Show All Labels
                                maxTicksLimit: 15
                            }
                        },

                        y: { display: true, position: 'left', grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: { size: 9 } }, border: { display: false } }
                    },
                    interaction: { intersect: false, mode: 'nearest', axis: 'x' }
                }
            });

        }

        function canFormat(v) { return v && !isNaN(parseFloat(v)); }
        function formatNumber(v) { let f = parseFloat(v); return (f > 0 ? '+' : '') + f.toFixed(2); }
        function getDirection(v) { if (String(v).includes('-')) return 'down'; if (String(v).includes('+') || parseFloat(v) > 0) return 'up'; return 'neutral'; }

    </script>
</body>

</html>