# TroubleShoot.md - Render 139 에러 및 데이터 정합성 해결

## 이슈 개요
- **현상**: Render Free 인스턴스에서 서비스 운영 중 `exit status 139`와 함께 서버가 반복적으로 재시작됨.
- **주요 원인**: 메모리 부족(Startup 부하), 의존성 결여, 수집원 보안 강화 등.

## 이슈별 원인 및 해결

### 1. Render 139 에러 (Segmentation Fault / OOM)
- **원인**: 1년치 히스토리 데이터를 10여 개 지표에 대해 한꺼번에 로드하면서 메모리 피크가 512MB를 초과함.
- **해결**: 
    1. **단일 잡 분할**: 통합 히스토리 수집 작업을 10개의 개별 잡으로 쪼개어 스케줄링.
    2. **Throttling (1분 간격)**: 각 지표 수집 사이에 1분간의 유예 시간을 두어 메모리 사용량이 누적되지 않고 즉시 해제되도록 최적화.

### 2. 하이일드 스프레드 및 기준금리 누락
- **원인**: 클라우드 IP 차단으로 인한 Investing.com 웹 크롤링 빈번한 실패.
- **해결**: **Hybrid 모델** 도입. 크롤링 실패 시 FRED API(일간 지표: BAMLH0A0HYM2, DFF)로 즉시 폴백하여 중단 없는 데이터 제공.

### 3. 외국인 주식 보유 데이터 수집 실패
- **원인**: 
    1. KRX 보안 강화로 인한 크롤링 불가.
    2. e-나라지표 전환 후 HTML Table 구조 분석 시 KOSPI 행 인덱스 오인식 (1/4 -> 3/6).
- **해결**: 
    1. 수집원을 **e-나라지표(index.go.kr)**로 전격 교체.
    2. 파싱 인덱스를 **3(금액) 및 6(비중)**으로 정정하고 유가증권시장 텍스트 검증 로직 추가.

### 4. 히스토리 차트 미생성 (Misfire)
- **원인**: 서버 기동이 지연될 경우 APScheduler가 예약된 차트 업데이트 작업을 '미스파이어'로 간주하여 실행 취소함.
- **해결**: `misfire_grace_time=3600`(1시간) 정책을 적용하여 기동이 늦어져도 수집 작업이 보장되도록 수정.

### 5. 프론트엔드 연동 및 URL 불일치
- **원인**: 한국 기준금리 URL 오설정 및 폴백 시 클릭 링크 미갱신.
- **해결**:
    1. 한국 기준금리 링크를 `ID: 473` 페이지로 전수 교체.
    2. `updateUI` 함수에서 백엔드가 제공하는 동적 URL(FRED 등)을 실시간으로 클릭 이벤트에 바인딩하도록 보강.

---

## 최종 조치 결과 (요약)
1. **메모리 최적화**: Startup 딜레이 및 History 지연 수집 적용 완료.
2. **의존성 해결**: `pykrx` 등 필수 라이브러리 `requirements.txt` 반영 확인.
3. **데이터 수집 고도화**: Hybrid 모델(IndexerGo + FRED 일간) 및 e-나라지표(KOSPI) 수집 정합성 확보.
4. **스케줄러 안정화**: Misfire 유예 정책 적용으로 차트 생성 보장.
5. **동적 URL 시스템**: 폴백 발생 시 대시보드 클릭 링크가 대체 출처로 자동 연동됨.
6. **UI 최저화**: 외인보유 데이터의 불필요한 필드 마스킹 및 단위 표기 개선.
